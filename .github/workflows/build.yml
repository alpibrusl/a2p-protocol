name: Build

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-typescript:
    name: Build TypeScript Packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check TypeScript packages
        run: pnpm typecheck

      - name: Build all packages
        run: pnpm build

      - name: Verify build artifacts
        run: |
          # Check TypeScript SDK
          test -f packages/sdk/typescript/dist/index.js || exit 1

          # Check TypeScript adapters
          for adapter in packages/adapters/*/typescript/package.json; do
            if [ -f "$adapter" ]; then
              dir=$(dirname "$adapter")
              if [ -f "$dir/package.json" ] && grep -q '"build"' "$dir/package.json"; then
                echo "Checking $dir"
                test -d "$dir/dist" || test -d "$dir/lib" || echo "Warning: $dir may not have build output"
              fi
            fi
          done

  build-python:
    name: Build Python Packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel

      - name: Build Python SDK
        working-directory: packages/sdk/python
        run: |
          pip install -e .[dev]
          python -m build

      - name: Verify Python SDK build
        working-directory: packages/sdk/python
        run: |
          test -f dist/*.whl || exit 1
          test -f dist/*.tar.gz || exit 1

      - name: Build Python adapters
        run: |
          for adapter in packages/adapters/*/python/pyproject.toml packages/adapters/*/pyproject.toml; do
            if [ -f "$adapter" ]; then
              dir=$(dirname "$adapter")
              echo "Building $dir"
              cd "$dir"
              python -m build || echo "Warning: $dir build failed"
              cd - > /dev/null
            fi
          done
